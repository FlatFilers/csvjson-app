/* CSVJSON | (c) 2022 Flatfile | https://github.com/FlatFilers/csvjson-app */
// js/src/jquery.cache-inputs.js
(function($){$.fn.CacheInputs=function(options){var settings=$.extend({key:'cache-inputs',selector:['input[type=text]','input[type=radio]','input[type=checkbox]','select'].join(', '),ignoreOnStart:false},options);function on_change(event){var $input=$(event.target),key=settings.key,name=$input.attr('name'),data=JSON.parse(localStorage[key]);if($input.attr('type')=='checkbox'){data[name]=$input.is(':checked');}else{data[name]=$input.val();}
localStorage[key]=JSON.stringify(data);}
return this.each(function(){var $el=$(this),selector=settings.selector;if(typeof(Storage)!=="undefined"){var key=settings.key;var data=false;if(localStorage[key]){data=JSON.parse(localStorage[key]);}
if(!data){localStorage[key]=JSON.stringify({});data=JSON.parse(localStorage[key]);}
$el.find(selector).change(on_change);if(!settings.ignoreOnStart)
$el.find(selector).each(function(){if($(this).attr('type')!='submit'){var $input=$(this),name=$input.attr('name'),value=data[name];if(value===undefined)return true;if($input.attr('type')=='checkbox'){if(value){$input.attr('checked',true);}else{$input.removeAttr('checked');}}else if($input.attr('type')=='radio'){if(value==$input.val()){$input.attr('checked',true);}else{$input.removeAttr('checked');}}else{$input.val(value);}}});}});};}(jQuery));
// js/src/csv2json.js
APP.csv2json=function(){var uploadUrl='/csv2json/upload',sepMap={comma:',',semiColon:';',tab:'\t'},$file=$('#fileupload'),$separator=$('select[name=separator]'),$parseNumbers=$('input[type=checkbox][name=parseNumbers]'),$parseJSON=$('input[type=checkbox][name=parseJSON]'),$transpose=$('input[type=checkbox][name=transpose]'),$output=$('input[type=radio][name=output]'),$csv=$('#csv'),$result=$('#result'),$clear=$('#clear, a.clear'),$convert=$('#convert, a.convert'),$minify=$('#minify');$convert.click(function(e){e.preventDefault();var csv=_.trim($csv.val()),separator=$separator.find('option:selected').val(),options={transpose:$transpose.is(':checked'),hash:$output.filter(':checked').val()=='hash',parseNumbers:$parseNumbers.is(':checked'),parseJSON:$parseJSON.is(':checked')},json;if(separator!='auto')options.separator=sepMap[separator];try{json=CSVJSON.csv2json(csv,options);}catch(error){APP.reportError($result,error);return false;}
var result=JSON.stringify(json,null,$minify.is(':checked')?undefined:2);$result.removeClass('error').val(result).change();try{if(options.transpose==false&&options.hash==false&&_.isArray(json)&&json.length>0){var columns=_.keys(json[0]).join(', ');if(columns!='album, year, US_peak_chart_post'&&columns!=window.csv2json_intrumented_columns){$.post('/csv2json/instrument',{columns:columns,num_rows:json.length,});window.csv2json_intrumented_columns=columns;}}}catch(error){}});APP.start({$convert:$convert,$clear:$clear,$saveElements:$('input.save, textarea.save'),upload:{$file:$file,url:uploadUrl,$textarea:$csv}});};
// js/src/json2csv.js
APP.json2csv=function(){var uploadUrl='/json2csv/upload',sepMap={comma:',',semiColon:';',tab:'\t'},$file=$('#fileupload'),$separator=$('select[name=separator]'),$json=$('#json'),$result=$('#result'),$clear=$('#clear, a.clear'),$convert=$('#convert, a.convert'),$flatten=$('#flatten'),$output_csvjson_variant=$('#output_csvjson_variant');$convert.click(function(e){e.preventDefault();var json=_.trim($json.val());if(json.length==0){APP.reportError($result,'Please upload a file or type in something.');return false;}
var options={separator:sepMap[$separator.find('option:selected').val()],flatten:$flatten.is(':checked'),output_csvjson_variant:$output_csvjson_variant.is(':checked')};var data;try{data=jsonlint.parse(json);}catch(error){APP.reportError($result,"Invalid JSON.\n\n"+error);return false;}
var result;try{result=CSVJSON.json2csv(data,options);}catch(error){APP.reportError($result,error+"\n\nOH NO! I don't know how to convert that. Help me understand what you want. Click on the button below to report a bug or suggestion.");return false;}
$result.removeClass('error').val(result).change();});APP.start({$convert:$convert,downloadFilename:'csvjson.csv',downloadMimeType:'text/plain',$clear:$clear,$saveElements:$('input.save, textarea.save'),upload:{$file:$file,url:uploadUrl,$textarea:$json}});};
// js/src/sql2json.js
APP.sql2json=function(){var uploadUrl="/sql2json/upload";var $file=$('#fileupload'),$format=$('input[type=radio][name=format]'),$sql=$('#sql'),$result=$('#result'),$clear=$('#clear, a.clear'),$convert=$('#convert, a.convert'),$minify=$('#minify');$convert.click(function(e){e.preventDefault();var sql=_.trim($sql.val());if(sql.length==0)return err(errorEmpty);var json;try{json=CSVJSON.sql2json(sql);}catch(error){APP.reportError($result,error);return false;}
var format=$format.filter(':checked').val(),space=$minify.is(':checked')?undefined:2,result='';if(format=="json")
result=JSON.stringify(json,null,space);else
result=_.reduce(json,function(result,table,name){return result+"var "+name+" = "+JSON.stringify(table,null,space)+";\n";},'');$result.removeClass('error').val(result).change();});APP.start({$convert:$convert,$clear:$clear,$saveElements:$('input.save, textarea.save'),upload:{$file:$file,url:uploadUrl,$textarea:$sql}});};
// js/src/json_beautifier.js
APP.json_beautifier=function(){var uploadUrl="/json_beautifier/upload",spaceMap={'tab':'\t','1':1,'2':2,'3':3,'4':4,'.':'.','..':'..'};var $file=$('#fileupload');var $json=$('#json');var $result=$('#result');var $resultNote=$('span.result-note');var $clear=$('#clear, a.clear');var $convert=$('#convert, a.convert');$clear.click(function(e){$resultNote.empty();});$convert.click(function(e){e.preventDefault();$resultNote.empty();var json=_.trim($json.val());var options={space:spaceMap[$('#space').val()],quoteType:$('#quote-type').val(),dropQuotesOnKeys:$('#drop-quotes-on-keys').is(':checked'),dropQuotesOnNumbers:$('#drop-quotes-on-numbers').is(':checked'),inlineShortArrays:$('#inline-short-arrays').is(':checked')?Math.ceil(Math.max($result.width()/9,20)):false,inlineShortArraysDepth:parseInt($('#inline-short-arrays-depth').val(),10),minify:$('#minify').is(':checked')};if(options.inlineShortArrays)console.log('inlineShortArrays',options.inlineShortArrays);var data;try{data=jsonlint.parse(json);}catch(error){APP.reportError($result,"Invalid JSON.\n\n"+error);return false;}
var result;try{result=CSVJSON.json_beautifier(data,options);}catch(error){APP.reportError($result,error);$resultNote.text('Invalid JSON');return false;}
$result.removeClass('error').val(result).change();if(options.dropQuotesOnKeys||options.quoteType==='single')$resultNote.text('Invalid JSON, but valid JavaScript');});if(localStorage.csvjsonSavedJSON){$json.val(localStorage.csvjsonSavedJSON);delete localStorage.csvjsonSavedJSON;_.defer(function(){$convert.first().click();});}
APP.start({$convert:$convert,$clear:$clear,$saveElements:$('input.save, textarea.save, select.save'),upload:{$file:$file,url:uploadUrl,$textarea:$json}});};
// js/src/json_validator.js
APP.json_validator=function(){function nl2br(str,is_xhtml){var breakTag=(is_xhtml||typeof is_xhtml==='undefined')?'<br />':'<br>';return(str+'').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,'$1'+breakTag+'$2');}
var uploadUrl="/json_validator/upload";var $file=$('#fileupload');var $json=$('#result');var $status=$('#status');var $clear=$('#clear, a.clear');var $convert=$('#convert, a.convert');var editor=CodeMirror.fromTextArea($json[0],{lineNumbers:true,mode:"application/json",gutters:["CodeMirror-lint-markers"],lint:true});editor.on('update',function(){var value=editor.getValue()||'';$json.val(value).change();var lineErrors=[];JSHINT(value);for(var i=0;i<JSHINT.errors.length;++i){var err=JSHINT.errors[i];if(!err)continue;if(lineErrors.indexOf(err.line)===-1)lineErrors.push(err.line);}
if(lineErrors.length){var msg='Error on line ';if(lineErrors.length>1)msg='Errors on lines: ';$status.removeClass('alert-default alert-success alert-info').addClass('alert-danger').html(msg+lineErrors.join(', '));}else if(value.trim().length==0){$status.removeClass('alert-success alert-danger alert-info').addClass('alert-default').empty();}else{var msg='JSON valid. Need more formatting options? Try <a class="beautify" href="/json_beautifier">JSON Beautifier</a>.';$status.removeClass('alert-default alert-danger alert-info').addClass('alert-success').html(msg);}});$status.on('click','a.beautify',function(e){e.preventDefault();localStorage.csvjsonSavedJSON=editor.getValue();window.location=$(this).attr('href');});$clear.click(function(e){editor.setValue('');});$convert.click(function(e){e.preventDefault();var json=_.trim(editor.getDoc().getValue());var options={inlineShortArrays:true,inlineShortArraysDepth:2};var result;try{result=CSVJSON.json_beautifier(json,options);}catch(error){var message=error.message||'Missing JSON';$status.removeClass('alert-default alert-success alert-info').addClass('alert-danger').html(nl2br(message));return false;}
editor.getDoc().setValue(result);});APP.start({$convert:$convert,$clear:$clear,$saveElements:$('input.save, textarea.save, select.save'),editor:editor,upload:{$file:$file,url:uploadUrl,editor:editor}});};
// js/src/csvjson2json.js
APP.csvjson2json=function(){var uploadUrl='/csv2json/upload',$file=$('#fileupload'),$output=$('input[type=radio][name=output]'),$csv=$('#csv'),$result=$('#result'),$clear=$('#clear, a.clear'),$convert=$('#convert, a.convert'),$resultNote=$('span.result-note'),$minify=$('#minify');$convert.click(function(e){e.preventDefault();var csv=_.trim($csv.val()),options={},json;try{json=CSVJSON.csvjson2json(csv,options);}catch(error){APP.reportError($result,error);return false;}
$resultNote.text(options.noHeaderKeysUseIndex?'Some header values were not strings. Using column position as keys.':'');var result=JSON.stringify(json,null,$minify.is(':checked')?undefined:2);$result.removeClass('error').val(result).change();});APP.start({$convert:$convert,$clear:$clear,$saveElements:$('input.save, textarea.save'),upload:{$file:$file,url:uploadUrl,$textarea:$csv}});};
// js/src/datajanitor-helpers.js
(function(){_.isEmail=function(email){if(!email||!_.isString(email))return false;var re=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email);}
_.notify=function(message,type){var $notify=$('<div class="notify show alert alert-'+(type||'default')+'">'+message+'</div>');$notify.appendTo('body');setTimeout(function(){$notify.remove();},4000);}}.call(this));
// js/src/datajanitor-store.js
(function(){var bareText,bareCode,exampleText,exampleCode;Backbone.DataStore=Backbone.Model.extend({defaults:{id:null,date:null,options:{name:null,autoDetectHeader:true,inputPageSize:5,outputPageSize:5,codeInputRowStart:0,codeOutputRowStart:0},text:exampleText,code:exampleCode,request:{status:undefined,email:undefined,message:undefined,outputSampleText:undefined,}},urlRoot:function(){return APP.baseUrl()+'/session';},initialize:function(attrs,options){var postfix=attrs&&attrs.id?('_'+attrs.id):'';var data={};function migrateKey(from,to){if(localStorage[from]===undefined)return;localStorage[to]=localStorage[from];delete localStorage[from];}
migrateKey('DataCleanInputOptions'+postfix,'DataJanitorInputOptions'+postfix);migrateKey('DataCleanInputText'+postfix,'DataJanitorInputText'+postfix);migrateKey('DataCleanCode'+postfix,'DataJanitorCode'+postfix);function createSessions(){var sessions=[];try{sessions=JSON.parse(window.localStorage.DataJanitorSessions);}catch(err){}
var keys=_.keys(window.localStorage);_.each(keys,function(key){var parts=key.split('_');if(parts.length==2&&parts[0]=='DataJanitorCode'&&sessions.indexOf(parts[1])===-1)
sessions.push(parts[1]);});if(this.id&&sessions.indexOf(this.id)===-1)sessions.push(this.id);window.localStorage.DataJanitorSessions=JSON.stringify(sessions);}
createSessions();function createSessionNames(){var names={};try{names=JSON.parse(window.localStorage.DataJanitorSessionNames);}catch(err){window.localStorage.DataJanitorSessionNames=JSON.stringify(names);}}
createSessionNames();if(localStorage['DataJanitorInputOptions'+postfix]!==undefined)
try{data.options=JSON.parse(localStorage['DataJanitorInputOptions'+postfix]);}catch(err){}
if(localStorage['DataJanitorInputText'+postfix]!==undefined)
data.text=localStorage['DataJanitorInputText'+postfix];if(localStorage['DataJanitorCode'+postfix]!==undefined)
data.code=localStorage['DataJanitorCode'+postfix];if(localStorage['DataJanitorRequest'+postfix]!==undefined)
try{data.request=JSON.parse(localStorage['DataJanitorRequest'+postfix]);}catch(err){}
this.set(data);function createMissingOptions(){this.set({options:_.extend({inputPageSize:Backbone.DataStore.prototype.defaults.options.inputPageSize,outputPageSize:Backbone.DataStore.prototype.defaults.options.outputPageSize,codeInputRowStart:Backbone.DataStore.prototype.defaults.options.codeInputRowStart,codeOutputRowStart:Backbone.DataStore.prototype.defaults.options.codeOutputRowStart},this.get('options'))});}
createMissingOptions.apply(this);this.on('change',this.saveToLocalStorage);this.maybeUpdateSessions();},save:function(){return Backbone.Model.prototype.save.apply(this,arguments).done(function(){this.clearLocalStorage();this.maybeUpdateSessions();}.bind(this));},destroy:function(){return Backbone.Model.prototype.destroy.apply(this,arguments).done(function(){this.clearLocalStorage();this.removeFromSessions();}.bind(this));},isLocalStorageDifferentThanServer:function(){if(!this.id)return true;var postfix='_'+this.id;return(localStorage['DataJanitorInputOptions'+postfix]||localStorage['DataJanitorInputText'+postfix]||localStorage['DataJanitorCode'+postfix]||localStorage['DataJanitorRequest'+postfix]);},saveToLocalStorage:function(){var postfix=this.id?('_'+this.id):'';if(this.hasChanged('options'))
localStorage['DataJanitorInputOptions'+postfix]=JSON.stringify(this.get('options'));if(this.hasChanged('text'))
localStorage['DataJanitorInputText'+postfix]=this.get('text');if(this.hasChanged('code'))
localStorage['DataJanitorCode'+postfix]=this.get('code');if(this.hasChanged('request'))
localStorage['DataJanitorRequest'+postfix]=JSON.stringify(this.get('request'));if(this.id)this.maybeUpdateSessions();},clearLocalStorage:function(){var postfix=this.id?('_'+this.id):'';delete localStorage['DataJanitorInputOptions'+postfix];delete localStorage['DataJanitorInputText'+postfix];delete localStorage['DataJanitorCode'+postfix];delete localStorage['DataJanitorRequest'+postfix];},clearDataOptionsCode:function(){var postfix=this.id?('_'+this.id):'';delete localStorage['DataJanitorInputOptions'+postfix];localStorage['DataJanitorInputText'+postfix]=bareText;localStorage['DataJanitorCode'+postfix]=bareCode;},clearData:function(){var postfix=this.id?('_'+this.id):'';localStorage['DataJanitorInputText'+postfix]=bareText;},clearCode:function(){var postfix=this.id?('_'+this.id):'';localStorage['DataJanitorCode'+postfix]=bareCode;},getSessions:function(){return JSON.parse(window.localStorage.DataJanitorSessions);},getSessionNames:function(){return JSON.parse(window.localStorage.DataJanitorSessionNames);},removeFromSessions:function(){if(!this.id)return;window.localStorage.DataJanitorSessions=JSON.stringify(_.without(this.getSessions(),this.id));},maybeUpdateSessions:function(){var sessions=this.getSessions();if(this.id&&sessions.indexOf(this.id)===-1){sessions.push(this.id);window.localStorage.DataJanitorSessions=JSON.stringify(sessions);}
var names=this.getSessionNames();var name=this.get('options').name||undefined;if(names[this.id]!=name){if(!name){delete names[this.id];}else{names[this.id]=name;}
window.localStorage.DataJanitorSessionNames=JSON.stringify(names);}}},{hydrateDefaults:function(){bareText=$('pre#bare-data').text();bareCode=$('pre#bare-code').text();exampleText=$('pre#example-data').text();exampleCode=$('pre#example-code').text();Backbone.DataStore.prototype.defaults.text=exampleText;Backbone.DataStore.prototype.defaults.code=exampleCode;}});}.call(this));
// js/src/datajanitor-sessions.js
(function(){Backbone.SessionsView=Backbone.View.extend({template:_.template(`<h3>Sessions</h3><ul class="nav nav-pills nav-stacked"><li class="session clearfix <%=!id ? 'active' : ''%>"><a class="pull-left"href="/datajanitor"title="Saved to local storage. Never sent to the server.">Sandbox</a><%if(!id){%><div class="dropdown session-dropdown"><button class="btn btn-default btn-xs dropdown-toggle"data-toggle="dropdown"><span class="caret"></span></button><ul class="dropdown-menu dropdown-menu-left"><li><a href="#"class="clear-local-storage"title="Resets data, options and code to the original example.">Reset sandbox to example</a></li><li><a href="#"class="clear-data-options-code"title="Clear data and code to start from scratch.">Clear data and code</a><li role="separator"class="divider"></li><li><a href="#"class="save-session"title="Save a permalink to share with a colleague."><i class="glyphicon glyphicon-link"></i>&nbsp;Save</a></li></ul></div><%}%></li><%for(var i=0;i<sessions.length;i++){%><li class="session clearfix <%=id == sessions[i] ? 'active' : ''%>"><a class="pull-left"href="/datajanitor/<%=sessions[i]%>"title="Saved to server. Changes are saved to local storage until you click Save again."><i class="glyphicon glyphicon-link"></i>&nbsp;<%=names[sessions[i]]||sessions[i].substr(0,8)%></a><%if(sessions[i]==id){%><div class="dropdown session-dropdown"><button class="btn btn-default btn-xs pull-right"data-toggle="dropdown"><span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#"class="clear-local-storage"title="Reverts data, options and code changes to the last version saved to the server.">Reset session to server</a></li><li><a href="#"class="clear-data-options-code"title="Clear data and code to start from scratch.">Clear data and code</a><li role="separator"class="divider"></li><li><a href="#"class="rename-session"title="Rename the session"><i class="glyphicon glyphicon-tag"></i>&nbsp;Rename</a></li><li><a href="#"class="save-session"title="Save changes to server"><i class="glyphicon glyphicon-link"></i>&nbsp;Save</a></li><li role="separator"class="divider"></li><li><a href="#"class="delete-session text-danger"title="Permanently delete this session."><i class="glyphicon glyphicon-trash"></i>&nbsp;Delete</a></li></ul></div><%}%></li><%}%></ul><br/><div class="panel"><%if(!id){%><p><em>Sandbox session is auto-saved on your computer.&nbsp;Never sent to server.&nbsp;<i class="glyphicon glyphicon-info-sign text-muted"data-toggle="tooltip"data-placement="bottom"title="Your input data and code is auto-saved to local storage. Click on the Save link to persist to server in order to share with colleagues."></i></em></p><%}else{%><%if(isDirty){%><p><em>Local copy different than on server.&nbsp;Click&nbsp;<i class="glyphicon glyphicon-link"></i>&nbsp;Save to update on server.&nbsp;<i class="glyphicon glyphicon-info-sign text-muted"data-toggle="tooltip"data-placement="bottom"title="Changes were auto-saved to local storage. However they differ from the version on the server."></i></em></p><%}else{%><p><em>Current session is saved on server.</em></p><%}%><%}%></div>`),events:{'click .clear-local-storage':'onClickClearLocalStorage','click .clear-data-options-code':'onClickClearDataOptionsCode','click .clear-data':'onClickClearData','click .save-session':'onSaveSession'},initialize:function(options){this.store=options.store;this.listenTo(this.store,'change',this.render);},onClickClearLocalStorage:function(e){e.preventDefault();this.store.clearLocalStorage();window.location.reload();},onClickClearDataOptionsCode:function(e){e.preventDefault();this.store.clearDataOptionsCode();window.location.reload();},onClickClearData:function(e){e.preventDefault();this.store.clearData();window.location.reload();},onSaveSession:function(e){this.trigger('save',e);},toRender:function(){return _.extend({id:this.store.id,sessions:this.store.getSessions(),names:this.store.getSessionNames(),isDirty:this.store.isLocalStorageDifferentThanServer()},this.store.get('options'));},render:function(){var data=this.toRender();this.$el.html(this.template(data));this.$('[data-toggle="tooltip"]').tooltip();new Backbone.DeleteView({el:this.$('.delete-session'),store:this.store}).render();new Backbone.RenameView({el:this.$('.rename-session'),store:this.store,sessionsView:this}).render();return this;}});Backbone.DeleteView=Backbone.View.extend({modalTemplate:_.template(`<div class="modal fade"id="delete-modal"tabindex="-1"role="dialog"><div class="modal-dialog modal-sm"role="document"><div class="modal-content"><div class="modal-header"><button type="button"class="close"data-dismiss="modal"><span>&times;</span></button><h4 class="modal-title text-danger">Delete Session</h4></div><div class="modal-body"><p class="text-center">Are you sure you want to delete this session and remove it from the server?</p><p class="status text-center"></p></div><div class="modal-footer"><button type="button"class="btn btn-danger confirm">Delete</button><button type="button"class="btn btn-default"data-dismiss="modal">Cancel</button></div></div></div></div>`),events:{'click':'onClick'},initialize:function(options){this.store=options.store;},onClick:function(e){e.preventDefault();$('#delete-modal').modal();},onConfirm:function(){this.renderModalState('deleting');this.store.destroy({wait:true}).done(function(){this.renderModalState('deleted');window.location.href='/datajanitor';}.bind(this)).fail(function(xhr){var error=xhr.responseText?xhr.responseText:'Unexpected error saving.';this.renderModalState('error',error);}.bind(this));},renderModalState:function(state,error){var $status=this.$modal.find('p.status');var $confirm=this.$modal.find('button.confirm');switch(state){case'deleted':$status.html('Deleted from server.');break;case'deleting':$status.html('<i class="glyphicon glyphicon-refresh glyphicon-spin"></i> Please wait while we remove from server...');$confirm.attr('disabled','disabled');break;case'error':$status.html(error?error:'An unexpected error while saving.');$confirm.attr('disabled','disabled');break;}
return this;},render:function(){this.$modal=$(this.modalTemplate({}));$('body').append(this.$modal);this.$modal.on('click','.confirm',this.onConfirm.bind(this));return this;}});Backbone.RenameView=Backbone.View.extend({modalTemplate:_.template(`<div class="modal fade"id="rename-modal"tabindex="-1"role="dialog"><div class="modal-dialog modal-sm"role="document"><div class="modal-content"><div class="modal-header"><button type="button"class="close"data-dismiss="modal"><span>&times;</span></button><h4 class="modal-title">Rename Session</h4></div><div class="modal-body"><div class="form-group"><div class="input-group"><label class="form-label">Name</label><input class="form-control"type="text"name="name"spellcheck="false"placeholder="<%=id%>"value="<%=name%>"/></div></div><p class="status text-center"></p></div><div class="modal-footer"><button type="button"class="btn btn-primary confirm">Save</button><button type="button"class="btn btn-default"data-dismiss="modal">Cancel</button></div></div></div></div>`),events:{'click':'onClick'},initialize:function(options){this.store=options.store;this.sessionsView=options.sessionsView;},onClick:function(e){e.preventDefault();this.$modal.modal();},onConfirm:function(){var options=_.extend({},this.store.get('options'),{name:this.$modal.find('input[name=name]').val()||null});this.renderModalState('saving');this.store.save({options:options,date:(new Date()).toUTCString()},{wait:true}).done(function(){this.renderModalState('saved');this.sessionsView.render();this.$modal.modal('hide');}.bind(this)).fail(function(xhr){var error=xhr.responseText?xhr.responseText:'Unexpected error saving.';this.renderModalState('error',error);}.bind(this));},renderModalState:function(state,error){var $status=this.$modal.find('p.status');var $confirm=this.$modal.find('button.confirm');switch(state){case'saved':$status.html('Saved to server.');break;case'saving':$status.html('<i class="glyphicon glyphicon-refresh glyphicon-spin"></i> Please wait while we save to server...');$confirm.attr('disabled','disabled');break;case'error':$status.html(error?error:'An unexpected error while saving.');$confirm.attr('disabled','disabled');break;}
return this;},render:function(){var id=this.store.id;var name=this.store.get('options').name;var data={id:id,name:id!==name?name:id};this.$modal=$(this.modalTemplate(data));$('body').append(this.$modal);this.$modal.on('click','.confirm',this.onConfirm.bind(this));this.$modal.find('input[name=name]').on('keyup',function(e){if(e.keyCode==13)this.onConfirm();}.bind(this));return this;}});}.call(this));
// js/src/datajanitor-data.js
(function(){Backbone.DataView=Backbone.View.extend({template:_.template(`<div class="row"><div class="col-md-12"><h4><span>Input</span>&nbsp;&nbsp;<small><%=inputRowCount%>&nbsp;rows</small><small class="pull-right"><div class="form-inline"><div class="form-group"><div class="checkbox"data-toggle="tooltip"data-placement="top"title="Auto-detect column header as the first row with non-empty cells. Ignore previous rows."><label class=""><input type="checkbox"name="autoDetectHeader"<%=autoDetectHeader?'checked':''%>/>Auto-detect header</label></div></div>&nbsp;&nbsp;<div class="form-group"><button class="btn btn-default btn-xs text-danger clear-input"data-toggle="tooltip"data-placement="top"title="Clear input data to start from scratch.">Clear</button></div>&nbsp;&nbsp;<div class="form-group"><button class="btn btn-default btn-xs copy-input"data-toggle="tooltip"data-placement="top"title="Copy table data so you can pasted in Excel or Google Sheets."><i class="glyphicon glyphicon-share"></i>&nbsp;Copy to clipboard</button></div>&nbsp;&nbsp;<div class="dropdown pull-right"><button class="btn btn-default btn-xs dropdown-toggle"data-toggle="dropdown"role="button"><span class="size"><%=inputPageSize%></span>&nbsp;<span class="caret"></span></button><ul class="dropdown-menu"><li class="dropdown-header">Page size</li><li><a href="#"class="input table-page-size"data-value="5">5 rows</a></li><li><a href="#"class="input table-page-size"data-value="10">10 rows</a></li><li><a href="#"class="input table-page-size"data-value="25">25 rows</a></li><li><a href="#"class="input table-page-size"data-value="50">50 rows</a></li><li><a href="#"class="input table-page-size"data-value="100">100 rows</a></li></ul></div></div></small></h4><table class="table table-bordered backgrid input"></table><h4><span>Output</span>&nbsp;&nbsp;<small><%=outputRowCount%>&nbsp;rows</small><small class="pull-right"><a class="btn btn-primary btn-xs download"download="datajanitor.csv"target="_self"data-toggle="tooltip"data-placement="top"title="Save as datajanitor.csv"><i class="glyphicon glyphicon-download"></i>&nbsp;Download CSV</a>&nbsp;&nbsp;<button class="btn btn-primary btn-xs copy-output"data-toggle="tooltip"data-placement="top"title="Copy table data so you can pasted in Excel or Google Sheets."><i class="glyphicon glyphicon-share"></i>&nbsp;Copy to clipboard</button>&nbsp;&nbsp;<div class="dropdown pull-right"><button class="btn btn-default btn-xs dropdown-toggle"data-toggle="dropdown"role="button"><span class="size"><%=outputPageSize%></span>&nbsp;<span class="caret"></span></button><ul class="dropdown-menu"><li class="dropdown-header">Page size</li><li><a href="#"class="output table-page-size"data-value="5">5 rows</a></li><li><a href="#"class="output table-page-size"data-value="10">10 rows</a></li><li><a href="#"class="output table-page-size"data-value="25">25 rows</a></li><li><a href="#"class="output table-page-size"data-value="50">50 rows</a></li><li><a href="#"class="output table-page-size"data-value="100">100 rows</a></li></ul></div></small></h4><table class="table table-bordered backgrid output"></table></div></div>`),events:{'change input[name=autoDetectHeader]':'onChangeAutoDetectOption','click button.clear-input':'clearInput','click button.copy-input':'copyInput','click button.copy-output':'copyOutput','click a.download':'onClickDownload','click .table-page-size':'onClickTablePageSize'},initialize:function(options){this.store=options.store;this.inputCollection=options.inputCollection;this.outputCollection=options.outputCollection;this.codeView=options.codeView;var storeOptions=this.store.get('options');this.inputCollection.setPageSize(storeOptions.inputPageSize);this.outputCollection.setPageSize(storeOptions.outputPageSize);this.listenTo(this.store,'change:id',this.render);this.listenTo(this.outputCollection,'reset',this.render);$(document).on('paste',this.onPaste.bind(this));_.defer(function(){this.parsePastedText();}.bind(this));},onClickTablePageSize:function(e){e.preventDefault();var $a=$(e.currentTarget);var size=parseInt($a.data('value'),10);var option='inputPageSize';var collection=this.inputCollection;if($a.hasClass('output')){option='outputPageSize';collection=this.outputCollection;}
$a.closest('ul.dropdown-menu').siblings('button.dropdown-toggle').find('.size').text(size);var options=_.extend({},this.store.get('options'));options[option]=size;this.store.set({options:options});collection.setPageSize(size);},onChangeAutoDetectOption:function(e){var options=_.extend({},this.store.get('options'),{autoDetectHeader:this.$('input[name=autoDetectHeader]').is(':checked')});this.store.set({options:options});this.parsePastedText();},clearInput:function(){this.store.clearData();window.location.reload();},copyInput:function(){_.copyToClipboard(this.inputCollection.toCSV('\t'));this.$('button.copy-input').yes();},copyOutput:function(){_.copyToClipboard(this.outputCollection.toCSV('\t'));this.$('button.copy-output').yes();},onClickDownload:function(e){var $download=this.$('a.download');if($download.attr('disabled'))return;var data='data:application/json;charset=utf-8,'+this.outputCollection.toCSV(',');$download.yes();download(data,$download.attr('download'),'application/json');},parsePastedText:function(){this.inputCollection.fullCollection.reset();var options=this.store.get('options');var text=(this.store.get('text')||'').trim();var lines=text?text.split('\n'):[];var columns=[];var rows=[];var maxCols=0;var rowWithColumnHeaders;lines.forEach(function(rowAsText,r){var row=rowAsText.split('\t').map(function(colAsText){return colAsText.trim().replace(/^"(.*)"$/,'$1');});while(row.length&&!row[row.length-1])row.pop();if(options.autoDetectHeader&&rowWithColumnHeaders===undefined&&row.length==_.compact(row).length){rowWithColumnHeaders=r;}
if(row.length>maxCols)maxCols=row.length;rows.push(row);});if(!options.autoDetectHeader||rowWithColumnHeaders===undefined){for(var i=0;i<maxCols;i++)columns.push(i+'');}else{var columns=rows[rowWithColumnHeaders].map(function(s){return s.trim();});}
Backbone.InputModel.setColumns(columns);rows.forEach(function(row,r){var error;if(options.autoDetectHeader&&rowWithColumnHeaders!==undefined&&rowWithColumnHeaders>=r){error='Header row and previous rows will not be processed. To use index-based column headers instead, un-toggle the auto-detect header option.';return true;}
var model=new Backbone.InputModel({__Row:this.inputCollection.fullCollection.size(),__Error:error});row.forEach(function(value,c){var name=columns[c];model.set(name,value);}.bind(this));this.inputCollection.fullCollection.add(model);}.bind(this));this.inputCollection.trigger('ready');this.render();},onPaste:function(e){if(!this.$el.hasClass('active'))return;if(!e.originalEvent||!e.originalEvent.clipboardData||!e.originalEvent.clipboardData.items)return;var data=_.findWhere(e.originalEvent.clipboardData.items,{type:'text/plain'});if(!data)return;data.getAsString(function(text){this.store.set({text:text.replace(/\r/g,'').trim('\n')});this.parsePastedText();_.notify(this.inputCollection.fullCollection.size()+' rows of data pasted into Input table.','success');}.bind(this));},toRender:function(){return _.extend({id:this.store.id,inputRowCount:this.inputCollection.fullCollection.size(),outputRowCount:this.outputCollection.fullCollection.size()},this.store.get('options'));},render:function(){var data=this.toRender();this.$el.html(this.template(data));this.$('[data-toggle="tooltip"]').tooltip();var inputColumns=[{name:'__Row',label:'',cell:Backgrid.RowCountCell,editable:false}];_.each(Backbone.InputModel.getColumns(),function(col){inputColumns.push({name:col,label:col,cell:Backgrid.ReportingCell,editable:false});});new Backgrid.Grid({el:this.$('table.input'),collection:this.inputCollection,columns:inputColumns,emptyText:'Copy data from Excel or Google Sheets (Ctrl+c). Then paste it on this page to fill this table (Ctrl+v).'}).render();new Backgrid.Extension.Paginator({collection:this.inputCollection}).render().$el.insertAfter(this.$('table.input'));var outputColumns=[{name:'__Row',label:'',cell:Backgrid.RowCountCell,editable:false}];if(this.outputCollection.fullCollection.size()){var keys=_.without(this.outputCollection.fullCollection.first().keys(),'__Row');_.each(keys,function(col){outputColumns.push({name:col,label:col,cell:Backgrid.ReportingCell,editable:false});});}
new Backgrid.Grid({el:this.$('table.output'),collection:this.outputCollection,columns:outputColumns,emptyText:this.codeView.error?'Error in process function. Please click on the Clean & Transform tab to correct it.':'No data'}).render();if(this.outputCollection.fullCollection.size()){new Backgrid.Extension.Paginator({collection:this.outputCollection}).render().$el.insertAfter(this.$('table.output'));}
var $download=this.$('a.download');if(this.outputCollection.size()==0){$download.attr('disabled',true);$download.attr('title','No data to download. Convert first.');}
return this;}});Backbone.InputModel=Backbone.Model.extend({defaults:{__Row:null,__Error:null},},{setColumns:function(columns){var defaults={__Row:null,__Error:null};_.each(columns,function(col){defaults[col]=null;});Backbone.InputModel.prototype.defaults=defaults;},getColumns:function(){return _.without(_.keys(Backbone.InputModel.prototype.defaults),'__Row','__Error');}});Backbone.InputCollection=Backbone.PageableCollection.extend({model:Backbone.InputModel,mode:'client',state:{pageSize:5},toCSV:function(separator){if(this.fullCollection.size()==0)return'';var keys=_.without(this.fullCollection.first().keys(),'__Row','__Error');var data=this.fullCollection.map(function(model){return model.pick(keys);});return _.convert(data,separator);}});Backbone.OutputModel=Backbone.Model.extend({defaults:{__Row:null}});Backbone.OutputCollection=Backbone.PageableCollection.extend({model:Backbone.OutputModel,mode:'client',state:{pageSize:5},toCSV:function(separator){if(this.fullCollection.size()==0)return'';var keys=_.without(this.fullCollection.first().keys(),'__Row');var data=this.fullCollection.map(function(model){return model.pick(keys);});return _.convert(data,separator);}});Backgrid.RowCountCell=Backgrid.Cell.extend({className:'reporting-cell',render:function(){this.$el.empty();var columnName=this.column.get('name');var value=this.model.get(columnName)+1;this.$el.html(value);var error=this.model.get('__Error');if(error){this.$el.append('&nbsp;<i class="glyphicon glyphicon-warning-sign text-danger" data-toggle="tooltip" data-placement="right" title="'+(error+'').replace(/"/g,"'")+'"></i>');this.$('[data-toggle="tooltip"]').tooltip();}
this.delegateEvents();return this;}});Backgrid.ReportingCell=Backgrid.Cell.extend({className:'reporting-cell',render:function(){this.$el.empty();var columnName=this.column.get('name');var rawValue=this.model.get(columnName);var formattedValue=this.formatter.fromRaw(rawValue,this.model);this.$el.html(formattedValue);if(formattedValue&&formattedValue.length&&formattedValue.length>20)
this.$el.attr('title',formattedValue);if(this.model.errorModel){var error=this.model.errorModel.get(columnName);if(error)this.$el.prepend('<i class="fa fa-fw fa-warning text-danger" title="'+(error+'').replace(/"/g,"'")+'"></i>&nbsp;');}
this.delegateEvents();return this;}});$.fn.yes=function(){this.each(function(){var $el=$(this);var classNames=$el.find('.glyphicon').attr('class');$el.find('.glyphicon').removeClass().addClass('glyphicon glyphicon-refresh glyphicon-spin');$el.attr('disabled',true);setTimeout(function(){$el.removeAttr('disabled');$el.find('.glyphicon').removeClass().addClass('glyphicon glyphicon-ok');setTimeout(function(){$el.find('.glyphicon').removeClass().addClass(classNames);},2000);},500);});};_.copyToClipboard=function(str){var $textarea=$('<textarea style="position:absolute;left:-9999px;" readonly></textarea>');$('body').append($textarea);$textarea.val(str);$textarea[0].select();document.execCommand('copy');$textarea.remove();};_.convert=function(data,separator){separator||(separator=',');if(!_.isObject(data))throw'Your JSON must be an array or an object.';if(!_.isArray(data))data=[data];var allKeys=[],allRows=[];for(var i=0;i<data.length;i++){var o=data[i],row={};if(o!==undefined&&o!==null&&(!_.isObject(o)||_.isArray(o)))
throw'Item in array is not an object: '+JSON.stringify(o);var keys=_.keys(o);for(var k=0;k<keys.length;k++){var key=keys[k];if(allKeys.indexOf(key)===-1)allKeys.push(key);var value=o[key];if(value===undefined&&value===null)continue;if(_.isString(value)){row[key]='"'+value.replace(/"/g,'""')+'"';}else{row[key]=JSON.stringify(value);if(_.isObject(value)||_.isArray(value))
row[key]='"'+row[key].replace(/"/g,'\\"').replace(/\n/g,'\\n')+'"';}}
allRows.push(row);}
keyValues=[];for(var i=0;i<allKeys.length;i++){keyValues.push('"'+allKeys[i].replace(/"/g,'""')+'"');}
var csv=keyValues.join(separator)+'\n';for(var r=0;r<allRows.length;r++){var row=allRows[r],rowArray=[];for(var k=0;k<allKeys.length;k++){var key=allKeys[k];rowArray.push(row[key]||'');}
csv+=rowArray.join(separator)+'\n';}
return csv;};}.call(this));
// js/src/datajanitor-code.js
(function(){Backbone.CodeView=Backbone.View.extend({template:_.template(`<div class="row"><div class="col-md-6"><h4><span>JavaScript</span><div class="form-inline pull-right"><small class="warning text-danger"></small><button class="btn btn-xs btn-success run">Run<em>(Ctrl+r)</em></button><button class="btn btn-xs btn-danger stop hidden"><i class="glyphicon glyphicon-refresh glyphicon-spin"></i>Stop</button><small>&nbsp;&nbsp;</small><button class="btn btn-xs btn-default text-danger clear-code"data-toggle="tooltip"data-placement="top"title="Clear code to start from scratch.">Clear</button></div></h4><textarea class="code"><%=code%></textarea></div><div class="col-md-3"><h4>Input&nbsp;<small class="input-row-count"><%=inputRowCount%></small><small class="form form-inline pull-right input-start">#&nbsp;<%var max=inputRowCount>2?inputRowCount-2:0;%><input name="codeInputRowStart"class="form-control row-start"type="number"min="0"max="<%=max%>"placeholder="0 to <%=max%>"value="<%=inputRowStart%>"/></small></h4><textarea class="input"><%=input%></textarea></div><div class="col-md-3"><h4>Output&nbsp;<small class="output-row-count"><%=outputRowCount||''%></small><small class="form form-inline pull-right output-start">#&nbsp;<%var max=outputRowCount>2?outputRowCount-2:0;%><input name="codeOutputRowStart"class="form-control row-start"type="number"min="0"max="<%=max%>"placeholder="0 to <%=max%>"value="<%=outputRowStart%>"/></small></h4><textarea class="output"><%=output%></textarea></div></div>`),events:{'click button.run':'run','click button.stop':'stop','click button.clear-code':'onClickClearCode','change input.row-start':'onChangeRowStart'},initialize:function(options){this.store=options.store;this.inputCollection=options.inputCollection;this.outputCollection=options.outputCollection;this.error=undefined;this.workerErrors=[];this.listenTo(this.inputCollection,'ready',this.run);this.listenTo(this.outputCollection,'reset',this.render);this.$tab=$(document).find('a[role=tab][href=#tab-code]');this.$tab.on('shown.bs.tab',this.render.bind(this));$(window).on('keydown',this.onKeydownCtrlR.bind(this));},onKeydownCtrlR:function(e){if($('#tab-code').is(':visible')&&(e.ctrlKey||e.metaKey)&&String.fromCharCode(e.which).toLowerCase()=='r'){e.preventDefault();this.run();}},onClickClearCode:function(){this.store.clearCode();localStorage.DataJanitorShowCodePage=true;window.location.reload();},onChangeRowStart:function(e){var $input=$(e.currentTarget);var start=parseInt($input.val(),10);if(isNaN(start))start=0;var name=$input.attr('name');var options=_.clone(this.store.get('options'));options[name]=start;this.store.set({options:options});this.render();},run:function(){this.$('button.run').addClass('hidden');this.$('button.stop').removeClass('hidden');this.isDirty=false;this.renderDirty();this.workerErrors=[];this.sandbox=new Worker('/js/src/sandbox.js?v='+APP.version);this.sandbox.addEventListener('message',function(e){this.error=undefined;for(var i=0;i<e.data.length;i++)e.data[i].__Row=i;this.outputCollection.fullCollection.reset(e.data);this.stop();}.bind(this));this.sandbox.addEventListener('error',function(e){this.error=e.message;this.workerErrors=[{message:e.message,lineno:e.lineno}];this.outputCollection.fullCollection.reset();this.stop();}.bind(this));var input=this.inputCollection.fullCollection.reduce(function(l,m){if(!m.get('__Error'))l.push(_.omit(m.toJSON(),'__Error','__Row'));return l;},[]);var code=this.store.get('code')+'\nprocess('+JSON.stringify(input)+', '+JSON.stringify(Backbone.InputModel.getColumns())+');';this.sandbox.postMessage(code);},stop:function(){this.sandbox.terminate();this.$('button.stop').addClass('hidden');this.$('button.run').removeClass('hidden');},getInputStartRow:function(){var options=this.store.get('options');return Math.max(0,Math.min(this.inputCollection.fullCollection.size()-2,options.codeInputRowStart||0));},getInputRowsToDisplay:function(){var inputRowStart=this.getInputStartRow();var i=0;var input=this.inputCollection.fullCollection.reduce(function(l,m){if(!m.get('__Error')){if(i>=inputRowStart&&l.length<2)l.push(_.omit(m.toJSON(),'__Row','__Error'));i+=1;}
return l;},[]);return input;},getOutputStartRow:function(){var options=this.store.get('options');return Math.max(0,Math.min(this.outputCollection.fullCollection.size()-2,options.codeOutputRowStart||0));},getOutputRowsToDisplay:function(){var outputRowStart=this.getOutputStartRow();var output=this.outputCollection.fullCollection.reduce(function(l,m,i){if(i>=outputRowStart&&l.length<2)l.push(_.omit(m.toJSON(),'__Row'));return l;},[]);return output},toRender:function(){return{isDirty:this.isDirty,code:this.store.get('code'),inputRowStart:this.getInputStartRow(),outputRowStart:this.getOutputStartRow(),inputRowCount:this.inputCollection.fullCollection.size(),outputRowCount:this.outputCollection.fullCollection.size(),input:JSON2_mod.stringify(this.getInputRowsToDisplay(),null,2),output:JSON2_mod.stringify(this.getOutputRowsToDisplay(),null,2),error:this.error};},renderDirty:function(){this.$('.warning').html(this.isDirty?'Pending changes&nbsp;<i class="glyphicon glyphicon-arrow-right"></i>&nbsp;':'');},renderInputOutputRows:function(data){if(!this.codeEditor||!this.$el.hasClass('active in'))return;data||(data=this.toRender());this.inputEditor.getDoc().setValue(data.input);this.outputEditor.getDoc().setValue(this.error||data.output);this.outputEditor.setOption('lineWrapping',!!this.error);var $inputInput=this.$('input[name=codeInputRowStart]');var inputMax=data.inputRowCount>2?data.inputRowCount-2:0;if($inputInput.val()!=data.inputRowStart)$inputInput.val(data.inputRowStart);if($inputInput.attr('max')!=inputMax)$inputInput.attr('max',inputMax);this.$('.input-row-count').text(data.inputRowCount?data.inputRowCount+' rows':'');var $outputInput=this.$('input[name=codeOutputRowStart]');var outputMax=data.outputRowCount>2?data.outputRowCount-2:0;if($outputInput.val()!=data.outputRowStart)$outputInput.val(data.outputRowStart);if($outputInput.attr('max')!=outputMax)$outputInput.attr('max',outputMax);this.$('.output-row-count').text(data.outputRowCount?data.outputRowCount+' rows':'');},renderWorkerErrors:function(){if(!this.codeEditor||!this.$el.hasClass('active in'))return;this.codeEditor.clearGutter('worker-error');var lineCount=$(this.codeEditor.getWrapperElement()).find('.CodeMirror-code > div:last-child div.CodeMirror-gutter-elt').text();for(var i=0;i<this.workerErrors.length;i++){var error=this.workerErrors[i];var lineno=error.lineno-1;if(lineno>=lineCount)lineno=0;var $marker=$('<div class="CodeMirror-lint-marker-error worker-error" data-toggle="tooltip" data-placement="auto left" data-container="body" title="'+error.message+'"></div>');this.codeEditor.getDoc().setGutterMarker(lineno,'worker-error',$marker[0]);$marker.tooltip();}},render:function(){if(this.error){this.$tab.html('<small class="text-danger" title="'+this.error+'"><i class="glyphicon glyphicon-exclamation-sign"></i></small> Clean &amp; Transform');}else{this.$tab.html('Clean &amp; Transform');}
if(!this.$el.hasClass('active in'))return this;var data=this.toRender();if(this.$el.is(':empty')){this.$el.html(this.template(data));this.$('[data-toggle="tooltip"]').tooltip();this.codeEditor=CodeMirror.fromTextArea(this.$('textarea.code')[0],{lineNumbers:true,mode:'text/javascript',styleActiveLine:true,gutters:['CodeMirror-lint-markers','worker-error'],lint:true,indentUnit:2});this.codeEditor.setSize('100%','100%');this.codeEditor.on('change',function(editor){this.store.set({code:editor.getDoc().getValue()});this.isDirty=true;this.renderDirty();}.bind(this));this.inputEditor=CodeMirror.fromTextArea(this.$('textarea.input')[0],{mode:'application/json',indentUnit:2});this.inputEditor.setSize('100%','100%');this.outputEditor=CodeMirror.fromTextArea(this.$('textarea.output')[0],{mode:'application/json',indentUnit:2});this.outputEditor.setSize('100%','100%');this.run();return this;}
this.renderInputOutputRows();this.renderWorkerErrors();this.renderDirty();return this;}});}.call(this));
// js/src/datajanitor-session.js
(function(){Backbone.SessionView=Backbone.View.extend({template:_.template(`<div class="row"><div class="col-md-8"><h4>Local Storage</h4><p>Your changes are always saved to local storage as you make them.If you close your browser,your session will remain and be restored next time you visit this page.</p></div></div><br/><div class="row"><div class="col-md-8"><h4>Saved to server</h4><%if(id){%><p>Your session was last saved:<%=date%>.It is available via this permalink.</p><div class="form-group"><div class="input-group"><input class="form-control"type="text"name="share-link"spellcheck="false"value="<%=window.location.href%>"/><span class="input-group-btn"><button class="btn btn-default btn-block copy-to-clipboard"onclick="document.execCommand('copy');"><i class="glyphicon glyphicon-share"></i>&nbsp;Copy</button></span></div></div><%}else{%><p>Your session can be saved to the server.Click on the<em>Save</em>button to get a permalink to share with co-workers.</p><div class="form-group"><button class="btn btn-primary"><i class="glyphicon glyphicon-link"></i>&nbsp;Save</button></div><%}%></div></div><br/><div class="row"><div class="col-md-8"><h4>Hire CSVJSON</h4></div></div><br/>`),events:{},initialize:function(options){this.store=options.store;this.$tab=$(document).find('a[role=tab][href=#tab-session]');this.$tab.on('shown.bs.tab',this.render.bind(this));},toRender:function(){return _.extend({id:this.store.id,date:this.store.get('date')},this.store.get('options'));},render:function(){if(!this.$el.hasClass('active in'))return this;var data=this.toRender();this.$el.html(this.template(data));this.$('[data-toggle="tooltip"]').tooltip();return this;}});}.call(this));
// js/src/datajanitor-share.js
(function(){Backbone.ShareView=Backbone.View.extend({modalTemplate:_.template(`<div class="modal fade"id="share-modal"tabindex="-1"role="dialog"><div class="modal-dialog"role="document"><div class="modal-content"><div class="modal-header"><button type="button"class="close"data-dismiss="modal"><span>&times;</span></button><h4 class="modal-title">Save and Share your Session</h4></div><div class="modal-body"><p class="status text-center"></p><div class="form-group"><div class="input-group"><input class="form-control"type="text"name="share-link"spellcheck="false"/><span class="input-group-btn"><button class="btn btn-default btn-block copy-to-clipboard"onclick="document.execCommand('copy');"><i class="glyphicon glyphicon-share"></i>&nbsp;Copy</button></span></div></div></div><div class="modal-footer"><button type="button"class="btn btn-default"data-dismiss="modal">Close</button></div></div></div></div>`),events:{'click':'onClick'},initialize:function(options){this.store=options.store;this.sessionsView=options.sessionsView;this.listenTo(this.sessionsView,'save',this.onClick);this.listenTo(this.store,'change:options change:text change:code',this.onChange);},onChange:function(){APP.renderSave('active');},onClick:function(e){e.preventDefault();$('#share-modal').modal();if(this.isDirtyOnServer())
this.save();else
this.renderModalState('saved');},isDirtyOnServer:function(){var isClean=APP.id&&APP.data&&APP.id==this.store.id&&APP.data.text==this.store.get('text')&&APP.data.code==this.store.get('code')&&_.isEqual(APP.data.options,this.store.get('options'));return!isClean;},save:function(){this.renderModalState('saving');this.store.save({date:(new Date()).toUTCString()},{wait:true}).done(function(){var newUrl=APP.baseUrl()+'/'+this.store.id;APP.id=this.store.id;APP.data=this.store.toJSON();this.store.saveToLocalStorage();if(window.location.href!=newUrl){if(window.history&&window.history.pushState)
window.history.pushState("","",newUrl);else
window.location.href=newUrl;}
this.renderModalState('saved');this.sessionsView.render();}.bind(this)).fail(function(xhr){var error=xhr.responseText?xhr.responseText:'Unexpected error saving.';this.renderModalState('error',error);}.bind(this));},renderModalState:function(state,error){var $modal=$('#share-modal');var $status=$modal.find('p.status');var $inputGroup=$modal.find('.input-group');var $input=$modal.find('input');switch(state){case'saved':$status.html('Saved to server.<br/>Copy the URL to share, or bookmark this page to save for later.');$inputGroup.show();$input.val(window.location.href);_.delay(function(){$input[0].select();},500);break;case'saving':$status.html('<i class="glyphicon glyphicon-refresh glyphicon-spin"></i> Please wait while we save to server...');$inputGroup.hide();break;case'error':$status.html(error?error:'An unexpected error while saving.');$inputGroup.hide();break;}
return this;},render:function(){if($('#share-modal').length==0){$('body').append(this.modalTemplate({}));}
return this;}});}.call(this));
// js/src/datajanitor-hire.js
(function(){Backbone.RequestModel=Backbone.Model.extend({defaults:{state:null,error:null,deate:null,email:null,message:null,output:null},urlRoot:'/datajanitor/hire',setFromStore:function(store){this.set(_.extend({id:store.id},store.get('request')));}});Backbone.HireView=Backbone.View.extend({modalTemplate:_.template(`<div class="modal-dialog"role="document"><div class="modal-content"><div class="modal-header"><button type="button"class="close"data-dismiss="modal"><span>&times;</span></button><h4 class="modal-title">Request Data Clean&Transform Service</h4></div><div class="modal-body"><%if(isNew){%><p>Please follow these steps to send a request:</p><ol><li>Ensure you have copy and pasted the input you want converted.</li><li>Provide your email,instructions and a sample output.</li><li>Click on Save&nbsp;&amp;&nbsp;Submit to send request.</li></ol><p>This will save your data,code and request.You will receive an email with a copy of this request.Future communications will happen via email.</p><%}else{%><p>Request submitted and saved to this URL.An email was sent on<%=store.date%>.</p><div class="form-group"><input class="form-control"type="text"name="share-link"spellcheck="false"value="<%=window.location.href%>"/></div><p>You may modify and click on Save and Submit to update your request.This will send another email.</p><hr/><%}%><form class="form"><div class="form-group"><label>Your email</label><input class="form-control"type="email"name="email"placeholder="email@example.com"value="<%=email%>"/></div><div class="form-group"><label>Instructions and ETA</label><textarea class="form-control"name="message"placeholder="instructions and expected turn around time"><%=message%></textarea></div><div class="form-group"><label>Sample output</label><textarea class="form-control"name="output"placeholder="paste a sample output"><%=output%></textarea></div></form><%if(error){%><div class="alert alert-danger"><p><i class="glyphicon glyphicon-exclamation-sign"></i><%=error%></p></div><%}%><%if(state=='saved'){%><div class="alert alert-success"><p><i class="glyphicon glyphicon-ok-circle"></i>&nbsp;Request saved and sent by email.</p></div><%}%></div><div class="modal-footer"><%if(state=='saving'||state=='emailing'){%><button type="button"class="btn btn-default"disabled><%=s.titleize(state)%>...</button><%}else if(state!='saved'){%><button type="button"class="btn btn-default cancel"data-dismiss="modal"><%=state=='saved'?'Close':'Cancel'%></button><button type="button"class="btn btn-primary submit">Save&nbsp;&amp;&nbsp;Submit</button><%}%></div></div></div>`),initialize:function(options){this.store=options.store;$('button.hire,a.hire').on('click',this.onClick.bind(this));this.model=new Backbone.RequestModel();this.model.setFromStore(this.store);},onClick:function(e){e.preventDefault();this.model.set(Backbone.RequestModel.prototype.defaults);this.model.setFromStore(this.store);this.render();this.$modal.modal();},onClickSubmit:function(){var $form=this.$modal.find('form');var email=$form.find('input[name=email]').val();if(!_.isEmail(email)){this.model.set({state:'error',error:'Missing or invalid email'});this.render();return;}
var message=$form.find('textarea[name=message]').val();if(message.trim().length==0){this.model.set({state:'error',error:'Please enter a message'});this.render();return;}
var output=$form.find('textarea[name=output]').val();this.model.set({state:'saving',error:null,email:email,message:message,output:output});this.render();this.store.save({date:(new Date()).toUTCString(),request:{email:email,message:message,output:output}},{wait:true}).done(function(){var newUrl=APP.baseUrl()+'/'+this.store.id;if(window.location.href!=newUrl){if(window.history&&window.history.pushState)
window.history.pushState("","",newUrl);else
window.location.href=newUrl;}
APP.id=this.store.id;APP.data=this.store.toJSON();this.model.set({state:'emailing',error:null});this.render();this.model.set({id:this.store.id});this.model.save().done(function(){this.model.set({state:'saved',error:null});this.render();}.bind(this)).fail(function(xhr){var error=xhr.responseText?xhr.responseText:'Unexpected error emailing.';this.model.set({state:'error',error:error});this.render();}.bind(this));}.bind(this)).fail(function(xhr){var error=xhr.responseText?xhr.responseText:'Unexpected error saving.';this.model.set({state:'error',error:error});this.render();}.bind(this));},toRender:function(){var data=_.extend(this.model.toJSON(),{store:this.store.toJSON()});var origRequest=data.store.request;data.isNew=!origRequest.email;return data;},render:function(){if(!this.$modal){this.$modal=$('<div class="modal fade" id="hire-modal" tabindex="-1" role="dialog"></div>');$('body').append(this.$modal);}
var data=this.toRender();this.$modal.html(this.modalTemplate(data));this.$modal.find('form').on('submit',function(e){e.preventDefault();});this.$modal.find('button.submit').on('click',this.onClickSubmit.bind(this));if(!data.isNew){$('.hire-cta-message').text('You sent a service request');$('button.hire').text('View/Modify Request');}
return this;}});}.call(this));
// js/src/datajanitor-not-found.js
(function(){Backbone.NotFoundView=Backbone.View.extend({template:_.template(`<div class="row"><div class="col-md-12 text-center"><h1>404 Not Found</h1><p class="lead">Oh no!&nbsp;Could not find that session.</p><p class="lead">Jump to your&nbsp;<a href="/datajanitor">Sandbox</a>.</p><%if(sessions.length){%><p>Or to an existing session:</p><ul class="nav nav-pills nav-stacked"><%for(var i=0;i<sessions.length;i++){%><li class="session"><a href="/datajanitor/<%=sessions[i]%>"><i class="glyphicon glyphicon-link"></i>&nbsp;<%=names[sessions[i]]||sessions[i].substr(0,8)%></a></li><%}%></ul><%}%></div></div><br/>`),initialize:function(options){this.store=options.store;},toRender:function(){return{sessions:this.store.getSessions(),names:this.store.getSessionNames()};},render:function(){var data=this.toRender();this.$el.html(this.template(data));return this;}});}.call(this));
// js/src/datajanitor.js
APP.datajanitor=function(){function go(){var inputCollection=window.inputCollection=new Backbone.InputCollection();var outputCollection=window.outputCollection=new Backbone.OutputCollection();var store=window.store=new Backbone.DataStore(_.extend({},APP.data,{id:APP.id||null}));var sessionsView=new Backbone.SessionsView({el:$('#sessions'),store:store}).render();var codeView=window.codeView=new Backbone.CodeView({el:$('#tab-code'),inputCollection:inputCollection,outputCollection:outputCollection,store:store}).render();var dataView=new Backbone.DataView({el:$('#tab-data'),inputCollection:inputCollection,outputCollection:outputCollection,store:store,codeView:codeView}).render();new Backbone.ShareView({el:$('a.save-permalink').first(),store:store,sessionsView:sessionsView}).render();new Backbone.HireView({el:$('button.hire').first(),store:store}).render();}
function goNotFound(){var store=window.store=new Backbone.DataStore({id:null});new Backbone.NotFoundView({el:$('.container-fluid.main-section'),store:store}).render();}
Backbone.DataStore.hydrateDefaults();if(localStorage.DataJanitorShowCodePage){delete localStorage.DataJanitorShowCodePage;$('.nav-tabs a[href="#tab-code"]').tab('show');}
if(APP.id&&APP.data_url){$.getJSON(APP.data_url).done(function(data){APP.data=data;go();}).fail(function(){goNotFound();});}else{go();}};
// js/src/home.js
APP.home=function(){};
// js/src/main.js
$(document).ready(function(){_.mixin(s.exports());_.extend(APP,{start:function(options){options||(options={});APP.bindDownload(options.downloadFilename,options.downloadMimeType);APP.bindCopy();APP.bindIssue();$('a.save-permalink').on('click',APP.onClickSave);if(options.upload){if(!options.upload.$file)throw"Invalid option 'upload'. Missing $file.";if(!options.upload.url)throw"Invalid option 'upload'. Missing url.";if(!options.upload.$textarea&&!options.upload.editor)throw"Invalid option 'upload'. Missing $textarea or editor.";APP.bindFileUploadToFillTextarea(options.upload.$file,options.upload.url,options.upload.$textarea,options.upload.editor);}
if(options.$convert)APP.bindConvert(options.$convert);if(options.$clear)APP.bindClear(options.$clear);if(options.$saveElements)APP.setInputsForSave(options.$saveElements);$('.container').CacheInputs({key:APP.page,ignoreOnStart:!!APP.id});if(APP.id){if(APP.data_url){$.getJSON(APP.data_url).done(function(data){APP.data=data;APP.restore(options.editor);});}else{APP.restore(options.editor);}}else{APP.renderSave('active');}},baseUrl:function(){return window.location.protocol+'//'+window.location.hostname+(window.location.port==80?'':(':'+window.location.port))+'/'+APP.page;},reportError:function($textarea,error){$textarea.addClass('error').val(error);},bindClear:function($clear){$clear.click(function(e){e.preventDefault();$('textarea.input, textarea.result').val('').removeClass('error').change();APP.renderSave('active');return false;});},bindConvert:function($convert){$convert.click(function(e){APP.renderSave('active');});},bindFileUploadToFillTextarea:function($file,uploadUrl,$textarea,editor){var $fileLabel=$file.siblings('label');var fileLabelHtml=$fileLabel.html();$file.fileupload({url:uploadUrl,pasteZone:null,progress:function(e,data){var progress=parseInt(data.loaded/data.total*100,10);$fileLabel.text(progress+'%');},success:function(result){$fileLabel.html(fileLabelHtml);if(editor){editor.setValue(result);}else{$textarea.val(result).change();}},fail:function(e,data){$fileLabel.html(fileLabelHtml);}});},bindDownload:function(filename,mimeType){filename||(filename='csvjson.json');mimeType||(mimeType='application/json');var $textarea=$('textarea.result'),$download=$('a#download'),$label=$('a#download').next('em'),nodata='No data to download. Convert first. ',data,copypaste='Ctrl + A then Ctrl + C to copy to clipboard. ';$download.attr('download',filename);$textarea.change(function(){data=$textarea.val();$download.attr('title','Download result in '+filename);$label.text(copypaste);if(data){$download.removeAttr('disabled');}else{$download.attr('disabled','disabled');$download.attr('title',nodata);$label.text(nodata+copypaste);}});$textarea.change();$download.click(function(e){if($download.attr('disabled'))return;e.preventDefault();download(new Blob([(filename.indexOf('.csv')>=0?"\uFEFF":'')+data]),$download.attr('download'),mimeType);});},bindCopy:function(){var $textarea=$('textarea.result'),$copy=$('a#copy');$copy.on('click',function(e){e.preventDefault();$textarea[0].select();document.execCommand('copy');});},$inputsForSave:[],setInputsForSave:function($inputs){APP.$inputsForSave=$inputs;APP.$inputsForSave.change(function(e){APP.renderSave('active');});},onClickSave:function(e){e.preventDefault();if($('a.save-permalink').closest('li').hasClass('disabled'))return false;APP.save();},save:function(){var url=APP.baseUrl()+'/save';if(APP.id)url+='/'+APP.id;var data={};APP.$inputsForSave.each(function(){var $el=$(this),id=$el.attr('id'),value=$el.is('input[type=radio], input[type=checkbox]')?$el.is(':checked'):$el.val();data[id]=value;});APP.renderSave('saving');return $.ajax(url,{type:'POST',data:JSON.stringify(data),contentType:'application/json'}).done(function(data){APP.id=data.id;var newUrl=APP.baseUrl()+'/'+data.id;if(window.location.href!=newUrl){if(window.history&&window.history.pushState)
window.history.pushState("","",newUrl);else
window.location.href=newUrl;}
APP.renderSave('saved');}).fail(function(xhr){var error=xhr.responseText?xhr.responseText:'Unexpected error saving.';APP.renderSave('error',error);});},restore:function(editor){if(!APP.data)return;_.each(APP.data,function(value,id){var $el=$('#'+id);if(!$el.length)return true;if($el.is('input[type=radio], input[type=checkbox]')){if(value)$el.attr('checked','checked');}else{if($el.is('textarea.result')&&editor){editor.setValue(value);}else{$el.val(value);}}
$('textarea.result').change();});APP.renderSave('saved');},renderSave:function(state,error){var $save=$('a.save-permalink');switch(state){case'active':if($save.hasClass('active'))return;$save.html('<i class="glyphicon glyphicon-link"></i> Save').attr('title','Save a permanent link to come back later, or to share with a colleague.'+(APP.id?' Will overwrite your previous work.':'')).closest('li').removeClass('disabled');break;case'saving':$save.html('<i class="glyphicon glyphicon-arrow-down"></i> Save').attr('title','Please wait...').closest('li').addClass('disabled');case'saved':$save.html('<i class="glyphicon glyphicon-link"></i> Saved').attr('title','Copy the URL in the address bar to share, or bookmark it to save for later.').closest('li').addClass('disabled');break;case'error':$save.html('<i class="glyphicon glyphicon-warning-sign"></i> Error saving').attr('title',error?error:'An unexpected error while saving.').closest('li').addClass('disabled');break;}},bindIssue:function(){var $issue=$('a#issue'),template=_.template(['<p>1. Save your test case (click on <span class="link-color"><i class="glyphicon glyphicon-link"></i> Save</span> in navbar). Copy the URL to the clipboard.</p>','<p>2. <a href="https://github.com/FlatFilers/csvjson-app/issues" target="_blank">Consult issues on GitHub.</a> If you find an existing issue matching yours, please comment and paste the URL of your test case.</p>','<p>3. If you do not find an existing issue, create one by clicking on this button: <a id="github-issue" class="btn btn-xs btn-primary" href="https://github.com/FlatFilers/csvjson-app/issues/new?body=<%=encodeURIComponent(url)%>" target="_blank">Create an issue in GitHub</a></p>'].join(' '));$issue.click(function(e){e.preventDefault();});$issue.popover({html:true,placement:"top",content:function(){return template({url:window.location.href});}});}});$('body').on('click',function(e){$('[data-toggle="popover"]').each(function(){if(!$(this).is(e.target)&&$(this).has(e.target).length===0&&$('.popover').has(e.target).length===0){$(this).popover('hide');}});});if(APP.run){var fn=APP[APP.page];if(typeof(fn)!=='function')throw"Module "+APP.page+" not found.";APP[APP.page]();}});
